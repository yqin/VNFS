%files
    /etc/passwd /etc
    /etc/shadow /etc
    /etc/group /etc
    /etc/gshadow /etc

%post
    # Variables
    export BLUEFIELD_VER=2.2.0.11000
    export RSHIM_VER=1.12-0
    export KERNEL_VER=3.10.0-1062.1.2
    export KERNEL_OS=el7
    export KERNEL_ARCH=x86_64

    # BLUEFIELD
    cd /tmp
    wget -c http://www.mellanox.com/downloads/BlueField/BlueField-${BLUEFIELD_VER}/BlueField-${BLUEFIELD_VER}.tar.xz
    tar Jxvpf BlueField-${BLUEFIELD_VER}.tar.xz
    RSHIM_SRPM=$( find BlueField-${BLUEFIELD_VER} -name rshim-${RSHIM_VER}.*.src.rpm )
    rpmbuild --rebuild --define "_topdir /tmp/rpmbuild" --define "KVERSION ${KERNEL_VER}.${KERNEL_OS}.${KERNEL_ARCH}" --clean ${RSHIM_SRPM}
    yum -ty install \
            /tmp/rpmbuild/RPMS/${KERNEL_ARCH}/rshim-${RSHIM_VER}.*.rpm
    rm -rf /tmp/rpmbuild

%post
    # Yum
    yum clean all
    rm -rf /var/lib/yum/yumdb/*

    # Misc
    rm -f /etc/passwd /etc/passwd- /etc/shadow /etc/shadow- /etc/group /etc/group- /etc/gshadow /etc/gshadow-
